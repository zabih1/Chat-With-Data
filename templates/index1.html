<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Data Intelligence Hub</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        .workspace-height {
            height: calc(100vh - 56px);
        }
        .user-message {
            background-color: #e3f2fd;
            border-radius: 12px 12px 0 12px;
            padding: 0.75rem 1rem;
            max-width: 75%;
            align-self: flex-end;
            word-wrap: break-word;
        }
        .bot-message {
            background-color: #f1f1f1;
            border-radius: 12px 12px 12px 0;
            padding: 0.75rem 1rem;
            max-width: 75%;
            align-self: flex-start;
            word-wrap: break-word;
        }
        .upload-zone {
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            cursor: pointer;
        }
        .sql-code {
            background-color: #282c34;
            color: #e6e6e6;
            border-radius: 5px;
            font-family: monospace;
        }
        /* Fix for long code blocks in chat */
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            max-width: 100%;
            overflow-x: auto;
        }
        /* Status message styling */
        .text-success {
            color: #28a745 !important;
        }
        .text-danger {
            color: #dc3545 !important;
        }
        /* Loading indicators */
        .loading-indicator {
            display: inline-block;
            margin-right: 0.5rem;
        }
    </style>
</head>

<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center gap-2" href="/">
                <i class="fas fa-brain text-primary"></i>
                <span>AI Data Intelligence Hub</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
                <span class="navbar-toggler-icon"></span>
            </button>
            
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid workspace-height">
        <div class="row h-100">
            <!-- Sidebar -->

            <div class="col-md-2 bg-light border-end py-3">
              <h5 class="mb-3 px-3">Workspace</h5>
              <div class="list-group list-group-flush">
                  <a href="#" class="list-group-item list-group-item-action active d-flex align-items-center" data-bs-toggle="list"
                      data-bs-target="#dashboardTab">
                      <i class="fas fa-home me-2"></i>
                      <span>Dashboard</span>
                  </a>
                  <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" data-bs-toggle="list"
                      data-bs-target="#databaseTab">
                      <i class="fas fa-database me-2"></i>
                      <span>Text to SQL</span>
                  </a>
                  <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" data-bs-toggle="list"
                      data-bs-target="#websiteTab">
                      <i class="fas fa-globe me-2"></i>
                      <span>Website Chat</span>
                  </a>
                  <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" data-bs-toggle="list"
                      data-bs-target="#youtubeTab">
                      <i class="fab fa-youtube me-2"></i>
                      <span class="text-nowrap">YouTube Summarizer</span>
                  </a>
                  <a href="#" class="list-group-item list-group-item-action d-flex align-items-center" data-bs-toggle="list"
                      data-bs-target="#documentChatTab">
                      <i class="fas fa-file-alt me-2"></i>
                      <span>Document Chat</span>
                  </a>
              </div>
            </div>
    
            <!-- Content Area -->
            <div class="col-md-10 py-3">
                <div class="tab-content h-100">
                    <!-- Dashboard Tab -->
                    <div class="tab-pane fade show active h-100" id="dashboardTab">
                        <div class="container h-100">
                            <h3 class="mb-4">Welcome to AI Data Intelligence Hub</h3>

                            <!-- Data Sources Cards -->
                            <div class="row mb-4 g-3">
                                <div class="col-md-4">
                                    <div class="card shadow-sm h-100" data-bs-toggle="list" data-bs-target="#databaseTab">
                                        <div class="card-body text-center py-4">
                                            <i class="fas fa-database fa-3x text-success mb-3"></i>
                                            <h5>Database Query</h5>
                                            <p class="text-muted">Query databases using natural language</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card shadow-sm h-100" data-bs-toggle="list"
                                        data-bs-target="#websiteTab">
                                        <div class="card-body text-center py-4">
                                            <i class="fas fa-globe fa-3x text-info mb-3"></i>
                                            <h5>Website Chat</h5>
                                            <p class="text-muted">Chat with any website content</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card shadow-sm h-100" data-bs-toggle="list"
                                        data-bs-target="#youtubeTab">
                                        <div class="card-body text-center py-4">
                                            <i class="fab fa-youtube fa-3x text-danger mb-3"></i>
                                            <h5>YouTube Summarizer</h5>
                                            <p class="text-muted">Get summaries of YouTube videos</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card shadow-sm h-100" data-bs-toggle="list"
                                        data-bs-target="#documentChatTab">
                                        <div class="card-body text-center py-4">
                                            <i class="fas fa-file-alt fa-3x text-primary mb-3"></i>
                                            <h5>Document Chat</h5>
                                            <p class="text-muted">Chat with your uploaded documents</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Text to SQL Tab -->
                    <div class="tab-pane fade h-100" id="databaseTab">
                        <div class="container h-100">
                            <div class="row h-100">
                                <!-- Database Sidebar -->
                                <div class="col-md-3">
                                    <div class="card shadow-sm h-100">
                                        <div class="card-header bg-success text-white">
                                            <h5 class="card-title mb-0">Database Information</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-3">
                                                <label for="dbConnection" class="form-label">Connection</label>
                                                <select class="form-select" id="dbConnection">
                                                    <option selected>Select database</option>
                                                    <option value="default_db" selected>Movie Database</option>
                                                </select>
                                            </div>

                                            <div class="mb-3">
                                                <h6 class="border-bottom pb-2">Available Tables</h6>
                                                <div class="list-group table-list">
                                                    <p class="text-muted small">Tables will load when connected</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Database Main Content -->
                                <div class="col-md-9">
                                    <div class="card shadow-sm h-100">
                                        <div class="card-header bg-success text-white">
                                            <h5 class="card-title mb-0">Database Query</h5>
                                        </div>
                                        <div class="card-body p-0 d-flex flex-column">
                                            <div class="d-flex justify-content-between p-3 border-bottom">
                                                <div>
                                                    <h6 class="mb-0" id="currentDatabase">Movie Database</h6>
                                                </div>
                                        
                                            </div>
                                            <div class="p-3">
                                                <form id="dbQueryForm" class="d-flex gap-2">
                                                    <input type="text" id="dbQueryInput" name="question" class="form-control"
                                                        placeholder="Enter your query in natural language..." />
                                                    <button type="submit" class="btn btn-success">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                </form>
                                            </div>
                                            <div id="queryResults" class="p-3 flex-grow-1">
                                                <div class="text-center my-5 text-muted">
                                                    <i class="fas fa-database fa-3x mb-3"></i>
                                                    <p>Enter a query to view results</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>  
                    
                    
                    <!-- Website Chat Tab -->
                    <div class="tab-pane fade h-100" id="websiteTab">
                        <div class="container h-100">
                            <div class="row h-100">
                                <!-- Website URL Section -->
                                <div class="col-md-3">
                                    <div class="card shadow-sm h-100">
                                        <div class="card-header bg-info text-white">
                                            <h5 class="card-title mb-0">Chat with Website</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-4">
                                                <label for="webAiModel" class="form-label">AI Model</label>
                                                <select class="form-select" id="webAiModel">
                                                    <!-- Will be populated dynamically -->
                                                </select>
                                            </div>
                                            <form id="websiteUrlForm" class="mb-4">
                                                <label for="websiteUrl" class="form-label">Website URL</label>
                                                <div class="input-group mb-3">
                                                    <input type="url" class="form-control" id="websiteUrl" 
                                                        placeholder="https://example.com" required>
                                                    <button class="btn btn-info" type="submit" id="websiteSubmitBtn">
                                                        <i class="fas fa-arrow-right"></i>
                                                    </button>
                                                </div>
                                                <div id="websiteStatus" class="small text-muted mt-2"></div>
                                            </form>
                                            
                                            <div class="mt-4">
                                                <h6 class="border-bottom pb-2">Recent Websites</h6>
                                                <div class="list-group recent-websites">
                                                    <p class="text-muted small">No recent websites</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Website Chat Section -->
                                <div class="col-md-9">
                                    <div class="card shadow-sm h-100">
                                        <div class="card-header bg-info text-white">
                                            <h5 class="card-title mb-0">Website Content Chat</h5>
                                        </div>
                                        <div class="card-body p-0 d-flex flex-column">
                                            <div class="d-flex justify-content-between p-3 border-bottom">
                                                <div>
                                                    <h6 class="mb-0" id="currentWebsite">No website selected</h6>
                                                </div>
                                            </div>
                                            <div id="webChatContainer" class="chat-area p-3 flex-grow-1 bg-light">
                                                <div class="text-center my-5 text-muted" id="webInitialMessage">
                                                    <i class="fas fa-globe fa-3x mb-3"></i>
                                                    <p>Enter a website URL to start chatting about its content</p>
                                                </div>
                                            </div>
                                            <div class="border-top p-3">
                                                <form id="webChatForm" class="d-flex gap-2">
                                                    <input type="text" id="webMessageInput" class="form-control"
                                                        placeholder="Ask a question about this website..." disabled />
                                                    <button type="submit" class="btn btn-info" disabled>
                                                        <i class="fas fa-paper-plane"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- YouTube Summarizer Tab -->
                    <div class="tab-pane fade h-100" id="youtubeTab">
                        <div class="container h-100">
                            <div class="row h-100">
                                <!-- YouTube URL Section -->
                                <div class="col-md-3">
                                    <div class="card shadow-sm h-100">
                                        <div class="card-header bg-danger text-white">
                                            <h5 class="card-title mb-0">YouTube Summarizer</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-4">
                                                <label for="ytAiModel" class="form-label">AI Model</label>
                                                <select class="form-select" id="ytAiModel">
                                                    <!-- Will be populated dynamically -->
                                                </select>
                                            </div>
                                            <form id="youtubeUrlForm" class="mb-4">
                                                <label for="youtubeUrl" class="form-label">YouTube URL</label>
                                                <div class="input-group mb-3">
                                                    <input type="url" class="form-control" id="youtubeUrl" 
                                                        placeholder="https://youtube.com/watch?v=..." required>
                                                    <button class="btn btn-danger" type="submit" id="youtubeSubmitBtn">
                                                        <i class="fas fa-arrow-right"></i>
                                                    </button>
                                                </div>
                                                <div id="youtubeStatus" class="small text-muted mt-2"></div>
                                            </form>
                                    
            
                                            <div class="mt-4">
                                                <h6 class="border-bottom pb-2">Recent Videos</h6>
                                                <div class="list-group recent-videos">
                                                    <p class="text-muted small">No recent videos</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Video Summary Section -->
                                <div class="col-md-9">
                                    <div class="card shadow-sm h-100">
                                        <div class="card-header bg-danger text-white">
                                            <h5 class="card-title mb-0">Video Summary</h5>
                                        </div>
                                        <div class="card-body p-0 d-flex flex-column">
                                            <div id="videoInfoContainer" class="p-3 border-bottom d-none">
                                                <div class="row align-items-center">
                                                    <div class="col-md-4" id="videoThumbnail">
                                                        <!-- Thumbnail will be inserted here -->
                                                    </div>
                                                    <div class="col-md-8">
                                                        <h5 id="videoTitle">Video Title</h5>
                                                        <p class="text-muted mb-1" id="videoChannel">Channel Name</p>
                                                        <p class="small text-muted mb-0" id="videoDuration">Duration: 00:00</p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div id="videoSummaryContainer" class="p-3 flex-grow-1 overflow-auto">
                                                <div class="text-center my-5 text-muted" id="ytInitialMessage">
                                                    <i class="fab fa-youtube fa-3x mb-3 text-danger"></i>
                                                    <p>Enter a YouTube URL to generate a summary</p>
                                                </div>
                                            </div>
                                            <div class="border-top p-3">
                                                <form id="summaryActionsForm" class="d-flex gap-2 d-none">
                                                    <button type="button" class="btn btn-outline-secondary flex-grow-1" id="copyBtn">
                                                        <i class="fas fa-copy me-1"></i> Copy Summary
                                                    </button>
                                                    <button type="button" class="btn btn-outline-secondary flex-grow-1" id="downloadBtn">
                                                        <i class="fas fa-download me-1"></i> Download
                                                    </button>
                                                    <button type="button" class="btn btn-danger flex-grow-1" id="regenerateBtn">
                                                        <i class="fas fa-sync-alt me-1"></i> Regenerate
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- chat with document Tab -->
                    <div class="tab-pane fade h-100" id="documentChatTab">
                        <div class="container h-100">
                            <div class="row h-100">
                                <!-- Document Upload Section -->
                                <div class="col-md-3">
                                    <div class="card shadow-sm h-100">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="card-title mb-0">Chat with Documents</h5>
                                        </div>
                                        <div class="card-body">
                                            <div class="mb-4">
                                                <label for="docAiModel" class="form-label">AI Model</label>
                                                <select class="form-select" id="docAiModel">
                                                    <!-- Will be populated dynamically -->
                                                </select>
                                            </div>
                                            <form id="documentUploadForm" class="mb-4">
                                                <label for="documentFile" class="form-label">Upload Document</label>
                                                <div class="upload-zone p-3 text-center mb-3" id="dropZone">
                                                    <i class="fas fa-cloud-upload-alt fa-2x mb-2 text-primary"></i>
                                                    <p class="mb-1">Drop your file here or click to browse</p>
                                                    <p class="small text-muted mb-0">PDF, TXT, DOCX (Max 10MB)</p>
                                                    <input type="file" id="documentFile" name="document" class="d-none">
                                                </div>
                                                <button type="submit" class="btn btn-primary w-100" id="uploadDocBtn">
                                                    <i class="fas fa-upload me-1"></i> Upload Document
                                                </button>
                                                <div id="documentStatus" class="small text-muted mt-2"></div>
                                            </form>
                                            
                                            <div class="d-grid mb-4">
                                                <button id="clearDocsBtn" class="btn btn-outline-danger">
                                                    <i class="fas fa-trash me-1"></i> Clear All Documents
                                                </button>
                                            </div>
                                            
                                            <div class="mt-4">
                                                <h6 class="border-bottom pb-2">Uploaded Documents</h6>
                                                <div class="list-group uploaded-documents">
                                                    <p class="text-muted small">No documents uploaded</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                    
                                <!-- Document Chat Section -->
                                <div class="col-md-9">
                                    <div class="card shadow-sm h-100">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="card-title mb-0">Document Chat</h5>
                                        </div>
                                        <div class="card-body p-0 d-flex flex-column">
                                            <div class="d-flex justify-content-between p-3 border-bottom">
                                                <div>
                                                    <h6 class="mb-0" id="currentDocuments">No documents uploaded</h6>
                                                </div>
                                            </div>
                                            <div id="docChatContainer" class="chat-area p-3 flex-grow-1 bg-light">
                                                <div class="text-center my-5 text-muted" id="docInitialMessage">
                                                    <i class="fas fa-file-alt fa-3x mb-3"></i>
                                                    <p>Upload a document to start chatting</p>
                                                </div>
                                            </div>
                                            <div class="border-top p-3">
                                                <form id="docChatForm" class="d-flex gap-2">
                                                    <input type="text" id="docMessageInput" class="form-control"
                                                        placeholder="Ask a question about your document..." disabled />
                                                    <button type="submit" class="btn btn-primary" disabled>
                                                        <i class="fas fa-paper-plane"></i>
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script>


            // Main initialization function
    document.addEventListener('DOMContentLoaded', function() {

      const MODELS = {{ models|tojson|safe }};

      
      // Global state
      const state = {
        currentWebsiteUrl: '',
        recentWebsites: [],
        recentVideos: [],
        uploadedDocuments: []
      };
      
      // Utility functions
      const utils = {
        // Show loading state on a button
        setLoading: (btn, isLoading, originalText = null) => {
          if (isLoading) {
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;
          } else {
            btn.innerHTML = originalText || btn.dataset.originalText;
            btn.disabled = false;
          }
        },
        
        // Update status message
        updateStatus: (elementId, message, isSuccess = true) => {
          const element = document.getElementById(elementId);
          element.textContent = message;
          element.className = `small ${isSuccess ? 'text-success' : 'text-danger'} mt-2`;
        },
        
        // Add message to chat container
        addChatMessage: (container, message, isUser = false) => {
          const messageDiv = document.createElement('div');
          messageDiv.className = isUser ? 'user-message' : 'bot-message';
          
          if (typeof message === 'string') {
            if (isUser) {
              messageDiv.textContent = message;
            } else {
              messageDiv.innerHTML = message;
            }
          } else {
            messageDiv.innerHTML = message;
          }
          
          container.appendChild(messageDiv);
          container.scrollTop = container.scrollHeight;
          return messageDiv;
        },
        
        // Update recent items list
        updateRecentList: (containerClass, items, clickCallback) => {
          const container = document.querySelector(`.${containerClass}`);
          if (!container) return;
          
          if (items.length === 0) {
            container.innerHTML = '<p class="text-muted small">No recent items</p>';
            return;
          }
          
          container.innerHTML = items.map(item => {
            // Get display text based on URL
            let displayText;
            try {
              const url = new URL(item);
              displayText = url.hostname.includes('youtube') ? 'YouTube Video' : url.hostname.replace('www.', '');
            } catch {
              displayText = item.length > 30 ? item.substring(0, 27) + '...' : item;
            }
            
            return `<a href="#" class="list-group-item list-group-item-action small py-2" title="${item}">${displayText}</a>`;
          }).join('');
          
          // Add click event listeners
          container.querySelectorAll('a').forEach((link, index) => {
            link.addEventListener('click', (e) => {
              e.preventDefault();
              clickCallback(items[index]);
            });
          });
        }
      };
      
      // Initialize all model dropdowns
      const initModelDropdowns = () => {
        ['webAiModel', 'ytAiModel', 'docAiModel'].forEach(selectId => {
          const select = document.getElementById(selectId);
          if (!select) return;
          
          select.innerHTML = '';
          
          MODELS.forEach(model => {
            const option = document.createElement('option');
            option.value = model.id;
            option.textContent = model.name;
            
            // Set default selection based on dropdown
            if ((selectId === 'webAiModel' || selectId === 'docAiModel') && model.id === 'deepseek') {
              option.selected = true;
            } else if (selectId === 'ytAiModel' && model.id === 'llama') {
              option.selected = true;
            }
            
            select.appendChild(option);
          });
        });
      };
      
      // Initialize website chat functionality
      const initWebsiteChat = () => {
        // Website URL form
        const urlForm = document.getElementById('websiteUrlForm');
        if (!urlForm) return;
        
        urlForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const urlInput = document.getElementById('websiteUrl');
          const url = urlInput.value.trim();
          const submitBtn = document.getElementById('websiteSubmitBtn');
          
          if (!url) return;
          
          // Basic URL validation
          try { new URL(url); } catch (_) {
            utils.updateStatus('websiteStatus', 'Please enter a valid URL', false);
            return;
          }
          
          // Show loading state
          const originalBtnHTML = submitBtn.innerHTML;
          utils.setLoading(submitBtn, true);
          utils.updateStatus('websiteStatus', 'Loading and indexing website content...', true);
          
          try {
            const response = await fetch('/api/prepare-website', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ website_url: url })
            });
            
            const data = await response.json();
            utils.setLoading(submitBtn, false, originalBtnHTML);
            
            if (data.success) {
              utils.updateStatus('websiteStatus', 'Website content loaded and indexed successfully!', true);
              
              // Update state
              state.currentWebsiteUrl = url;
              if (!state.recentWebsites.includes(url)) {
                state.recentWebsites.unshift(url);
                if (state.recentWebsites.length > 5) state.recentWebsites.pop();
                utils.updateRecentList('recent-websites', state.recentWebsites, (url) => {
                  document.getElementById('websiteUrl').value = url;
                  urlForm.dispatchEvent(new Event('submit'));
                });
              }
              
              // Update UI
              document.getElementById('currentWebsite').textContent = url;
              document.getElementById('webMessageInput').disabled = false;
              document.getElementById('webChatForm').querySelector('button').disabled = false;
              
              // Initialize chat with welcome message
              const chatContainer = document.getElementById('webChatContainer');
              chatContainer.innerHTML = '';
              utils.addChatMessage(chatContainer, 
                '<p class="mb-0">Website content processed and indexed. What would you like to know about this website?</p>'
              );
            } else {
              utils.updateStatus('websiteStatus', data.error || 'Unknown error', false);
            }
          } catch (error) {
            utils.setLoading(submitBtn, false, originalBtnHTML);
            utils.updateStatus('websiteStatus', 'Error: ' + error.message, false);
          }
        });
        
        // Website chat form
        const chatForm = document.getElementById('webChatForm');
        if (!chatForm) return;
        
        chatForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const messageInput = document.getElementById('webMessageInput');
          const message = messageInput.value.trim();
          const chatContainer = document.getElementById('webChatContainer');
          
          if (!message || !state.currentWebsiteUrl) return;
          
          // Add user message to chat
          utils.addChatMessage(chatContainer, message, true);
          messageInput.value = '';
          
          // Add loading indicator
          const loadingDiv = utils.addChatMessage(chatContainer, 
            '<div class="spinner-border spinner-border-sm text-info" role="status"></div> Thinking...'
          );
          
          try {
            const model = document.getElementById('webAiModel').value;
            const response = await fetch('/api/chat-with-website', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                website_url: state.currentWebsiteUrl,
                question: message,
                model: model
              })
            });
            
            const data = await response.json();
            chatContainer.removeChild(loadingDiv);
            utils.addChatMessage(chatContainer, data.answer);
          } catch (error) {
            chatContainer.removeChild(loadingDiv);
            utils.addChatMessage(chatContainer, `<p class="text-danger mb-0">Error: ${error.message}</p>`);
          }
        });
      };
      
      // Initialize YouTube summarizer
      const initYoutubeSummarizer = () => {
        // YouTube URL form
        const urlForm = document.getElementById('youtubeUrlForm');
        if (!urlForm) return;
        
        urlForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const urlInput = document.getElementById('youtubeUrl');
          const url = urlInput.value.trim();
          const model = document.getElementById('ytAiModel').value;
          const submitBtn = document.getElementById('youtubeSubmitBtn');
          
          if (!url) return;
          
          // Basic YouTube URL validation
          if (!url.includes('youtube.com/watch') && !url.includes('youtu.be/')) {
            utils.updateStatus('youtubeStatus', 'Please enter a valid YouTube URL', false);
            return;
          }
          
          // Show loading state
          const originalBtnHTML = submitBtn.innerHTML;
          utils.setLoading(submitBtn, true);
          utils.updateStatus('youtubeStatus', 'Processing video...', true);
          
          try {
            const response = await fetch('/api/youtube-summary', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ youtube_url: url, model: model })
            });
            
            const data = await response.json();
            utils.setLoading(submitBtn, false, originalBtnHTML);
            utils.updateStatus('youtubeStatus', 'Video processed successfully', true);
            
            // Update recent videos
            if (!state.recentVideos.includes(url)) {
              state.recentVideos.unshift(url);
              if (state.recentVideos.length > 5) state.recentVideos.pop();
              utils.updateRecentList('recent-videos', state.recentVideos, (url) => {
                document.getElementById('youtubeUrl').value = url;
                urlForm.dispatchEvent(new Event('submit'));
              });
            }
            
            // Update UI with video info and summary
            document.getElementById('videoInfoContainer').classList.remove('d-none');
            document.getElementById('videoTitle').textContent = "YouTube Video";
            document.getElementById('videoChannel').textContent = "YouTube Channel";
            document.getElementById('videoDuration').textContent = `Model: ${data.model}`;
            document.getElementById('videoThumbnail').innerHTML = `
              <img src="https://img.youtube.com/vi/${data.video_id}/0.jpg" alt="Video Thumbnail" class="img-fluid rounded">
            `;
            
            // Display summary
            const initialMessage = document.getElementById('ytInitialMessage');
            if (initialMessage) initialMessage.classList.add('d-none');
            
            document.getElementById('videoSummaryContainer').innerHTML = `
              <div class="card">
                <div class="card-header bg-light">
                  <h6 class="mb-0">Summary</h6>
                </div>
                <div class="card-body">
                  ${data.summary}
                </div>
              </div>
            `;
            
            // Show actions
            document.getElementById('summaryActionsForm').classList.remove('d-none');
          } catch (error) {
            utils.setLoading(submitBtn, false, originalBtnHTML);
            utils.updateStatus('youtubeStatus', 'Error: ' + error.message, false);
          }
        });
        
        // YouTube summary actions
        if (document.getElementById('copyBtn')) {
          document.getElementById('copyBtn').addEventListener('click', function() {
            const summaryContainer = document.querySelector('#videoSummaryContainer .card-body');
            const summaryText = summaryContainer ? summaryContainer.textContent.trim() : '';
            
            navigator.clipboard.writeText(summaryText)
              .then(() => {
                this.innerHTML = '<i class="fas fa-check me-1"></i> Copied';
                setTimeout(() => {
                  this.innerHTML = '<i class="fas fa-copy me-1"></i> Copy Summary';
                }, 2000);
              })
              .catch(() => {
                this.innerHTML = '<i class="fas fa-times me-1"></i> Failed';
                setTimeout(() => {
                  this.innerHTML = '<i class="fas fa-copy me-1"></i> Copy Summary';
                }, 2000);
              });
          });
        }
        
        if (document.getElementById('downloadBtn')) {
          document.getElementById('downloadBtn').addEventListener('click', function() {
            const videoTitle = document.getElementById('videoTitle').textContent || 'YouTube Video';
            const summaryContainer = document.querySelector('#videoSummaryContainer .card-body');
            const summaryText = summaryContainer ? summaryContainer.textContent.trim() : '';
            
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(summaryText));
            element.setAttribute('download', `${videoTitle} - Summary.txt`);
            element.style.display = 'none';
            
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
          });
        }
        
        if (document.getElementById('regenerateBtn')) {
          document.getElementById('regenerateBtn').addEventListener('click', async function() {
            const url = document.getElementById('youtubeUrl').value;
            const model = document.getElementById('ytAiModel').value;
            
            document.getElementById('videoSummaryContainer').innerHTML = `
              <div class="text-center my-5">
                <div class="spinner-border text-danger" role="status"></div>
                <p class="mt-3">Regenerating summary...</p>
              </div>
            `;
            
            try {
              const response = await fetch('/api/youtube-summary', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ youtube_url: url, model: model })
              });
              
              const data = await response.json();
              document.getElementById('videoDuration').textContent = `Model: ${data.model}`;
              document.getElementById('videoSummaryContainer').innerHTML = `
                <div class="card">
                  <div class="card-header bg-light">
                    <h6 class="mb-0">Summary</h6>
                  </div>
                  <div class="card-body">
                    ${data.summary}
                  </div>
                </div>
              `;
            } catch (error) {
              document.getElementById('videoSummaryContainer').innerHTML = `
                <div class="alert alert-danger">
                  <i class="fas fa-exclamation-circle me-2"></i>
                  Error: ${error.message}
                </div>
              `;
            }
          });
        }
      };
      
      // Initialize database query functionality
      const initDatabaseQuery = () => {
        const queryForm = document.getElementById('dbQueryForm');
        if (!queryForm) return;
        
        queryForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const questionInput = document.getElementById('dbQueryInput');
          const question = questionInput.value.trim();
          
          if (!question) return;
          
          // Show loading state
          const queryResults = document.getElementById('queryResults');
          queryResults.innerHTML = `
            <div class="text-center my-5">
              <div class="spinner-border text-success" role="status"></div>
              <p class="mt-3">Processing your query...</p>
            </div>
          `;
          
          try {
            const response = await fetch('/api/text_to_sql', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: new URLSearchParams({ 'question': question })
            });
            
            const data = await response.json();
            
            if (data.error) {
              throw new Error(data.error);
            }
            
            queryResults.innerHTML = `
              <div class="mb-3">
                <h6>SQL Query:</h6>
                <pre class="sql-code p-3">${data.query}</pre>
              </div>
              <div>
                <h6>Answer:</h6>
                <div class="p-3 bg-light rounded">
                  ${data.answer}
                </div>
              </div>
            `;
          } catch (error) {
            queryResults.innerHTML = `
              <div class="alert alert-danger">
                <i class="fas fa-exclamation-circle me-2"></i>
                Error: ${error.message}
              </div>
            `;
          }
        });
      };
      
      // Initialize document chat functionality
      const initDocumentChat = () => {
        // Document upload form
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('documentFile');
        const uploadForm = document.getElementById('documentUploadForm');
        
        if (dropZone && fileInput) {
          // Click on drop zone to trigger file input
          dropZone.addEventListener('click', () => fileInput.click());
          
          // Handle drag and drop events
          ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, (e) => {
              e.preventDefault();
              e.stopPropagation();
            });
          });
          
          // Add visual feedback for drag enter/leave
          dropZone.addEventListener('dragenter', () => {
            dropZone.classList.add('border', 'border-primary');
          });
          
          dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border', 'border-primary');
          });
          
          // Handle file drop
          dropZone.addEventListener('drop', (e) => {
            dropZone.classList.remove('border', 'border-primary');
            fileInput.files = e.dataTransfer.files;
          });
        }
        
        // Handle document upload
        if (uploadForm) {
          uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!fileInput || !fileInput.files || fileInput.files.length === 0) {
              utils.updateStatus('documentStatus', 'Please select a file to upload', false);
              return;
            }
            
            const file = fileInput.files[0];
            
            // Validate file size (10MB max)
            if (file.size > 10 * 1024 * 1024) {
              utils.updateStatus('documentStatus', 'File size exceeds 10MB limit', false);
              return;
            }
            
            // Check file extension
            const allowedExtensions = ['pdf', 'txt', 'docx'];
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (!allowedExtensions.includes(fileExtension)) {
              utils.updateStatus('documentStatus', 'Only PDF, TXT, and DOCX files are supported', false);
              return;
            }
            
            // Show loading state
            const uploadBtn = document.getElementById('uploadDocBtn');
            const originalBtnHTML = uploadBtn.innerHTML;
            utils.setLoading(uploadBtn, true);
            utils.updateStatus('documentStatus', 'Uploading and processing document...', true);
            
            try {
              const formData = new FormData();
              formData.append('document', file);
              
              const response = await fetch('/api/upload-document', {
                method: 'POST',
                body: formData
              });
              
              const data = await response.json();
              utils.setLoading(uploadBtn, false, originalBtnHTML);
              
              if (data.success) {
                utils.updateStatus('documentStatus', 'Document uploaded and processed successfully!', true);
                
                // Update state
                if (!state.uploadedDocuments.includes(data.document_name)) {
                  state.uploadedDocuments.push(data.document_name);
                  updateDocumentsList();
                }
                
                // Enable chat interface
                document.getElementById('docMessageInput').disabled = false;
                document.getElementById('docChatForm').querySelector('button').disabled = false;
                
                // Add welcome message
                const chatContainer = document.getElementById('docChatContainer');
                chatContainer.innerHTML = '';
                utils.addChatMessage(chatContainer, 
                  `<p class="mb-0">Document "${data.document_name}" has been processed. What would you like to know about it?</p>`
                );
                
                // Clear file input
                fileInput.value = '';
              } else {
                utils.updateStatus('documentStatus', data.error || 'Unknown error', false);
              }
            } catch (error) {
              utils.setLoading(uploadBtn, false, originalBtnHTML);
              utils.updateStatus('documentStatus', 'Error: ' + error.message, false);
            }
          });
        }
        
        // Update document lists
        const updateDocumentsList = () => {
          // Update uploaded documents list
          const container = document.querySelector('.uploaded-documents');
          if (container) {
            if (state.uploadedDocuments.length === 0) {
              container.innerHTML = '<p class="text-muted small">No documents uploaded</p>';
            } else {
              let html = '';
              state.uploadedDocuments.forEach(document => {
                html += `
                  <div class="list-group-item d-flex justify-content-between align-items-center py-2">
                    <span class="text-truncate" title="${document}">
                      <i class="fas fa-file me-2"></i> ${document}
                    </span>
                  </div>
                `;
              });
              container.innerHTML = html;
            }
          }
          
          // Update current documents display
          const currentDocumentsEl = document.getElementById('currentDocuments');
          if (currentDocumentsEl) {
            if (state.uploadedDocuments.length === 0) {
              currentDocumentsEl.textContent = 'No documents uploaded';
            } else if (state.uploadedDocuments.length === 1) {
              currentDocumentsEl.textContent = `Current document: ${state.uploadedDocuments[0]}`;
            } else {
              currentDocumentsEl.textContent = `${state.uploadedDocuments.length} documents uploaded`;
            }
          }
        };
        
        // Document chat form
        const chatForm = document.getElementById('docChatForm');
        if (chatForm) {
          chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const messageInput = document.getElementById('docMessageInput');
            const message = messageInput.value.trim();
            
            if (!message || state.uploadedDocuments.length === 0) return;
            
            // Add user message
            const chatContainer = document.getElementById('docChatContainer');
            utils.addChatMessage(chatContainer, message, true);
            messageInput.value = '';
            
            // Add loading indicator
            const loadingDiv = utils.addChatMessage(chatContainer, 
              '<div class="spinner-border spinner-border-sm text-primary" role="status"></div> Thinking...'
            );
            
            try {
              const model = document.getElementById('docAiModel').value;
              const response = await fetch('/api/chat-with-document', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  question: message,
                  model: model
                })
              });
              
              const data = await response.json();
              chatContainer.removeChild(loadingDiv);
              utils.addChatMessage(chatContainer, data.answer);
            } catch (error) {
              chatContainer.removeChild(loadingDiv);
              utils.addChatMessage(chatContainer, `<p class="text-danger mb-0">Error: ${error.message}</p>`);
            }
          });
        }
        
        // Clear documents button
        const clearBtn = document.getElementById('clearDocsBtn');
        if (clearBtn) {
          clearBtn.addEventListener('click', async function() {
            if (state.uploadedDocuments.length === 0) return;
            
            if (!confirm('Are you sure you want to clear all uploaded documents? This action cannot be undone.')) {
              return;
            }
            
            utils.setLoading(this, true);
            
            try {
              const response = await fetch('/api/clear-documents', { method: 'POST' });
              const data = await response.json();
              
              utils.setLoading(this, false, '<i class="fas fa-trash me-1"></i> Clear All Documents');
              
              if (data.success) {
                state.uploadedDocuments = [];
                updateDocumentsList();
                
                // Reset chat interface
                document.getElementById('docMessageInput').disabled = true;
                document.getElementById('docChatForm').querySelector('button').disabled = true;
                
                // Clear chat container
                document.getElementById('docChatContainer').innerHTML = `
                  <div class="text-center my-5 text-muted" id="docInitialMessage">
                    <i class="fas fa-file-alt fa-3x mb-3"></i>
                    <p>Upload a document to start chatting</p>
                  </div>
                `;
                
                utils.updateStatus('documentStatus', 'All documents cleared successfully', true);
              } else {
                utils.updateStatus('documentStatus', data.error || 'Unknown error', false);
              }
            } catch (error) {
              utils.setLoading(this, false, '<i class="fas fa-trash me-1"></i> Clear All Documents');
              utils.updateStatus('documentStatus', 'Error: ' + error.message, false);
            }
          });
        }
      };
      
      // Initialize all components
      initModelDropdowns();
      initWebsiteChat();
      initYoutubeSummarizer();
      initDatabaseQuery();
      initDocumentChat();
    });


    </script>
          
        </body>